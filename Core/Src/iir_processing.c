/* Includes ------------------------------------------------------------------*/
#include "iir.h"

uint32_t numBlocks = TEST_LENGTH_SAMPLES/BLOCK_SIZE;
float32_t 	aIIR_F32_Output[BLOCK_SIZE]={ 0 };
float32_t 	aIIR_F32_Output_Scaled[BLOCK_SIZE]={ 0 };

/* ----------------------------------------------------------------------
** Test BioZ input signal
** ------------------------------------------------------------------- */
float32_t aIIR_F32_BioZ_Test_Data[TEST_LENGTH_SAMPLES] =
{
		462.3303811	,
		462.3780648	,
		462.4138276	,
		462.4267419	,
		462.4138276	,
		462.431709	,
		462.4883334	,
		462.5270764	,
		462.547938	,
		462.5668128	,
		462.5787338	,
		462.5946283	,
		462.6224438	,
		462.6582066	,
		462.6860221	,
		462.6919826	,
		462.7227783	,
		462.7933105	,
		462.8638426	,
		462.9005988	,
		462.9304012	,
		462.9840453	,
		463.0337159	,
		463.0645116	,
		463.1032546	,
		463.1320635	,
		463.1151756	,
		463.1082217	,
		463.1509384	,
		463.210543	,
		463.2711411	,
		463.3367062	,
		463.3824031	,
		463.3883635	,
		463.3645217	,
		463.3376996	,
		463.3565744	,
		463.4022713	,
		463.4390275	,
		463.4757837	,
		463.5135333	,
		463.5284344	,
		463.510553	,
		463.5045926	,
		463.5363817	,
		463.5800918	,
		463.6307557	,
		463.6903604	,
		463.7300968	,
		463.7350639	,
		463.72811	,
		463.7400309	,
		463.7678464	,
		463.7936751	,
		463.8274511	,
		463.8870557	,
		463.950634	,
		463.9605681	,
		463.9218251	,
		463.916858	,
		463.9615615	,
		464.0152057	,
		464.0479883	,
		464.0847445	,
		464.1354084	,
		464.1711712	,
		464.1801119	,
		464.1920328	,
		464.2218351	,
		464.2486572	,
		464.2665386	,
		464.3032948	,
		464.3549522	,
		464.3946886	,
		464.4085964	,
		464.4205173	,
		464.4364119	,
		464.4403855	,
		464.4383987	,
		464.4532998	,
		464.4711812	,
		464.4860824	,
		464.5079374	,
		464.5337661	,
		464.5417134	,
		464.5188649	,
		464.506944	,
		464.5188649	,
		464.5297925	,
		464.5347595	,
		464.5556211	,
		464.5874103	,
		464.601318	,
		464.5893971	,
		464.6003246	,
		464.6291335	,
		464.6499952	,
		464.6509886	,
		464.6589359	,
		464.6758238	,
		464.6648963	,
		464.6410545	,
		464.651982	,
		464.6946987	,
		464.7046328	,
		464.6728436	,
		464.6460215	,
		464.6678766	,
		464.690725	,
		464.6629095	,
		464.6450281	,
		464.6678766	,
		464.6827777	,
		464.6460215	,
		464.6201928	,
		464.6410545	,
		464.6480083	,
		464.6062851	,
		464.5754894	,
		464.5834366	,
		464.5725091	,
		464.5188649	,
		464.4811153	,
		464.4870758	,
		464.501977	,
		464.4860824	,
		464.468201	,
		464.4811153	,
		464.468201	,
		464.4105832	,
		464.3837611	,
		464.4076029	,
		464.3966754	,
		464.3261433	,
		464.2893871	,
		464.3172026	,
		464.318196	,
		464.2347495	,
		464.151303	,
		464.1493162	,
		464.1622305	,
		464.1224941	,
		464.0936852	,
		464.1373952	,
		464.1671975	,
		464.0976588	,
		464.0042782	,
		464.001298	,
		464.0052716	,
		463.9267921	,
		463.8572534	,
		463.8801018	,
		463.911891	,
		463.8532797	,
		463.7748003	,
		463.7767871	,
		463.8135433	,
		463.8036092	,
		463.7688398	,
		463.7678464	,
		463.7638728	,
		463.6764526	,
		463.5681709	,
		463.5343949	,
		463.5492961	,
		463.5194937	,
		463.4797573	,
		463.483731	,
		463.4807507	,
		463.3923372	,
		463.2790883	,
		463.2174969	,
		463.2016023	,
		463.176767	,
		463.1419977	,
		463.116169	,
		463.0953074	,
		463.0257686	,
		462.9423221	,
		462.9155	,
		462.9055659	,
		462.8360271	,
		462.7684752	,
		462.7674818	,
		462.7724489	,
		462.7048969	,
		462.5995954	,
		462.5469446	,
		462.5499249	,
		462.542971	,
		462.5131687	,
		462.5012477	,
		462.4992609	,
		462.4426365	,
		462.3770714	,
		462.3651505	,
		462.3681307	,
		462.3264074	,
		462.2787237	,
		462.2926315	,
		462.3283943	,
		462.3154799	,
		462.2658094	,
		462.2350136	,
		462.2240861	,
		462.1942838	,
		462.1565342	,
		462.1406396	,
		462.1257385	,
		462.0780547	,
		462.0214303	,
		461.9926214	,
		461.9816939	,
		461.9598389	,
		461.9290431	,
		461.9280497	,
		461.9409641	,
		461.9091749	,
		461.8545373	,
		461.8386428	,
		461.8346691	,
		461.7919525	,
		461.7542028	,
		461.7700974	,
		461.7800315	,
		461.7174466	,
		461.6489013	,
		461.6459211	,
		461.6508881	,
		461.6101583	,
		461.580356	,
		461.5873098	,
		461.5654548	,
		461.5038633	,
		461.4671071	,
		461.4849885	,
		461.4800215	,
		461.4323378	,
		461.3995552	,
		461.4154498	,
		461.4174366	,
		461.3469044	,
		461.268425	,
		461.2574975	,
		461.2743855	,
		461.2525304	,
		461.2227281	,
		461.2187545	,
		461.212794	,
		461.1829917	,
		461.1760378	,
		461.2108072	,
		461.2058401	,
		461.106499	,
		461.0160987	,
		461.0349735	,
		461.0727231	,
		461.0319932	,
		460.973382	,
		460.9644413	,
		460.9634479	,
		460.9187444	,
		460.8809948	,
		460.8978828	,
		460.9018564	,
		460.8303308	,
		460.7488712	,
		460.7419173	,
		460.755825	,
		460.7220491	,
		460.7021809	,
		460.7448975	,
		460.7597987	,
		460.6773456	,
		460.5750243	,
		460.5740309	,
		460.6078068	,
		460.5730375	,
		460.5432351	,
		460.5869452	,
		460.6018464	,
		460.533301	,
		460.4736964	,
		460.5015119	,
		460.5253537	,
		460.438927	,
		460.3356123	,
		460.3356123	,
		460.3753487	,
		460.3455464	,
		460.2899154	,
		460.2839549	,
		460.2909088	,
		460.2601131	,
		460.2253437	,
		460.2243503	,
		460.2322976	,
		460.2144162	,
		460.1955414	,
		460.238258	,
		460.2879286	,
		460.2799813	,
		460.2680604	,
		460.3137573	,
		460.3674014	,
		460.361441	,
		460.3296518	,
		460.3366057	,
		460.3723685	,
		460.4250193	,
		460.4905844	,
		460.545222	,
		460.5621099	,
		460.5482022	,
		460.5491956	,
		460.60582	,
		460.6634378	,
		460.6654247	,
		460.6634378	,
		460.7160886	,
		460.7687394	,
		460.755825	,
		460.73397	,
		460.7756933	,
		460.8253638	,
		460.8511925	,
		460.8829816	,
		460.9475533	,
		460.9813293	,
		460.9614611	,
		460.9435797	,
		460.9753688	,
		461.0329866	,
		461.0657692	,
		461.0955715	,
		461.1372948	,
		461.1780246	,
		461.1929258	,
		461.1899455	,
		461.2118006	,
		461.24657	,
		461.2624645	,
		461.2882932	,
		461.3339901	,
		461.3637924	,
		461.3677661	,
		461.3777002	,
		461.4025354	,
		461.4373048	,
		461.4780347	,
		461.5177711	,
		461.5594943	,
		461.585323	,
		461.5873098	,
		461.6002242	,
		461.6449277	,
		461.7174466	,
		461.7740711	,
		461.7969195	,
		461.8227482	,
		461.8624846	,
		461.8932803	,
		461.8853331	,
		461.8813594	,
		461.9260629	,
		461.9956017	,
		462.0323579	,
		462.0522261	,
		462.0631536	,
		462.0482524	,
		462.042292	,
		462.0999098	,
		462.1813695	,
		462.2260729	,
		462.2379939	,
		462.2429609	,
		462.2568687	,
		462.2856776	,
		462.3105129	,
		462.3224338	,
		462.3323679	,
		462.3631636	,
		462.3959462	,
		462.4178012	,
		462.4227683	,
		462.4227683	,
		462.4287287	,
		462.4575377	,
		462.4893268	,
		462.5022411	,
		462.5161489	,
		462.542971	,
		462.5628392	,
		462.5717799	,
		462.5896613	,
		462.6055559	,
		462.6194636	,
		462.6403252	,
		462.6651605	,
		462.6830419	,
		462.6999299	,
		462.726752	,
		462.7625148	,
		462.7943039	,
		462.8370206	,
		462.8797372	,
		462.9025857	,
		462.9184802	,
		462.9174868	,
		462.8926516	,
		462.8876845	,
		462.9264275	,
		462.9810651	,
		463.0188147	,
		463.0297422	,
		463.0277554	,
		463.0178213	,
		463.0029202	,
		463.009874	,
		463.0555709	,
		463.1012678	,
		463.1141822	,
		463.1201426	,
		463.1419977	,
		463.1529252	,
		463.1509384	,
		463.1668329	,
		463.188688	,
		463.2006089	,
		463.3098841	,
		463.5622104	,
		463.7847344	,
		463.8810953	,
		463.928779	,
		464.0042782	,
		464.1046127	,
		464.1930262	,
		464.2516375	,
		464.3092553	,
		464.3728336	,
		464.4145568	,
		464.4403855	,
		464.4761483	,
		464.5377398	,
		464.5993312	,
		464.6311204	,
		464.6768173	,
		464.7503297	,
		464.7870859	,
		464.7642374	,
		464.7473494	,
		464.7741715	,
		464.8129145	,
		464.8377498	,
		464.8735126	,
		464.9122556	,
		464.9053017	,
		464.8794731	,
		464.891394	,
		464.9261634	,
		464.9490118	,
		464.9599393	,
		465.0006692	,
		465.0533199	,
		465.0592804	,
		465.0185506	,
		465.0155703	,
		465.0543133	,
		465.0692145	,
		465.0622606	,
		465.0900761	,
		465.1178916	,
		465.0940498	,
		465.0423924	,
		465.0264978	,
		465.0523265	,
		465.0602738	,
		465.0563002	,
		465.0880893	,
		465.1317994	,
		465.1178916	,
		465.0880893	,
		465.0851091	,
		465.1019971	,
		465.1000102	,
		465.0781552	,
		465.080142	,
		465.1019971	,
		465.080142	,
		465.0284847	,
		464.9976889	,
		464.9728537	,
		464.9182161	,
		464.874506	,
		464.8874203	,
		464.9142424	,
		464.8864269	,
		464.8387432	,
		464.8298025	,
		464.8337762	,
		464.7960265	,
		464.741389	,
		464.7304614	,
		464.7403955	,
		464.7036393	,
		464.6271467	,
		464.5844301	,
		464.5854235	,
		464.5655553	,
		464.5287991	,
		464.5228386	,
		464.506944

};

/* ----------------------------------------------------------------------
** IIR Coefficients buffer generated using butter and zp2sos MATLAB functions.
** [z,p,k] = butter(4,[0.1/32 0.8/32],'bandpass'); -> bandpass from 0.1Hz to 0.8 Hz, with Fs=64 Hz
** SOS=zp2sos(z,p,k);
** ------------------------------------------------------------------- */
float32_t aIIR_F32_Coeffs[5*NUM_STAGES] = {
+1.0000000000f, +2.0000000000f, +1.0000000000f,		+1.895722474789011f, -0.899411083778550f,    //b01 b11 b21      a11 a21
+1.0000000000f, +2.0000000000f, +1.0000000000f,		+1.948848547428271f, -0.954592824534871f,    //b02 b12 b22      a12 a22
+1.0000000000f, -2.0000000000f, +1.0000000000f,		+1.979030312810837f, -0.979181800278063f,    //b03 b13 b23      a13 a23
+1.0000000000f, -2.0000000000f, +1.0000000000f,		+1.993819636344761f, -0.993920434438280f,    //b04 b14 b24      a14 a24
};

float32_t IIR_F32_Gain = 1.276295709838403e-06;

//float32_t aIIR_F32_Coeffs[5*NUM_STAGES] = {
//+0.003518569050357f, +0.0000000000f, -0.00351856905035675f,		+1.98656177520752f, -0.992962956428528f,    //b01 b11 b21      a11 a21
//+0.039512060582638f, +0.0000000000f, -0.0395120605826378f,		+1.99209797382355f, -0.992197453975678f,    //b02 b12 b22      a12 a22
//+0.010433792136610f, +0.0000000000f, -0.0104337921366096f,		+1.97283113002777f, -0.979139924049377f,    //b03 b13 b23      a13 a23
//+0.040169950574636f, +0.0000000000f, -0.0401699505746365f,		+1.97710585594177f, -0.977261483669281f,    //b04 b14 b24      a14 a24
//+0.039932239800692f, +0.0000000000f, -0.0399322398006916f,		+1.91564321517944f, -0.920882582664490f,    //b04 b14 b24      a14 a24
//+0.044352807104588f, +0.0000000000f, -0.0443528071045876f,		+1.90754902362823f, -0.912478923797607f,    //b04 b14 b24      a14 a24
//+0.053739476948977f, +0.0000000000f, -0.0537394769489765f,		+1.89195239543915f, -0.895861923694611f,    //b04 b14 b24      a14 a24
//+0.055480737239122f, +0.0000000000f, -0.0554807372391224f,		+1.88978350162506f, -0.893360257148743f,    //b04 b14 b24      a14 a24
//+0.017100824043155f, +0.0000000000f, -0.0171008240431547f,		+1.95964074134827f, -0.965812683105469f,    //b04 b14 b24      a14 a24
//+0.023458424955606f, +0.0000000000f, -0.0234584249556065f,		+1.94716966152191f, -0.953162610530853f,    //b04 b14 b24      a14 a24
//+0.039432875812054f, +0.0000000000f, -0.0394328758120537f,		+1.98628294467926f, -0.986397504806519f,    //b04 b14 b24      a14 a24
//+0.039422802627087f, +0.0000000000f, -0.0394228026270866f,		+1.98414540290833f, -0.984267532825470f,    //b04 b14 b24      a14 a24
//+0.039115101099014f, +0.0000000000f, -0.0391151010990143f,		+1.99905979633331f, -0.999152302742004f,    //b04 b14 b24      a14 a24
//+0.038937874138355f, +0.0000000000f, -0.0389378741383553f,		+1.99735939502716f, -0.997452497482300f,    //b04 b14 b24      a14 a24
//+0.038974951952696f, +0.0000000000f, -0.0389749519526959f,		+1.99024260044098f, -0.990346014499664f,    //b04 b14 b24      a14 a24
//+0.038921777158976f, +0.0000000000f, -0.0389217771589756f,		+1.98830997943878f, -0.988418340682983f,    //b04 b14 b24      a14 a24
//+0.030487567186356f, +0.0000000000f, -0.0304875671863556f,		+1.97487771511078f, -0.975046575069428f,    //b04 b14 b24      a14 a24
//+0.013816053047776f, +0.0000000000f, -0.0138160530477762f,		+1.97339046001434f, -0.973568916320801f,    //b04 b14 b24      a14 a24
//+0.180082470178604f, +0.0000000000f, -0.180082470178604f,		+1.90085113048553f, -0.905450940132141f,    //b04 b14 b24      a14 a24
//+0.051033236086369f, +0.0000000000f, -0.0510332360863686f,		+1.89563500881195f, -0.899891257286072f,    //b04 b14 b24      a14 a24
//+0.056204840540886f, +0.0000000000f, -0.0562048405408859f,		+1.88893806934357f, -0.892228245735169f,    //b04 b14 b24      a14 a24
//+0.056591849774122f, +0.0000000000f, -0.0565918497741222f,		+1.88888263702393f, -0.891993284225464f,    //b04 b14 b24      a14 a24
//+0.029328979551792f, +0.0000000000f, -0.0293289795517921f,		+1.93558204174042f, -0.941357433795929f,    //b04 b14 b24      a14 a24
//+0.034787137061358f, +0.0000000000f, -0.0347871370613575f,		+1.92502796649933f, -0.930550813674927f,    //b04 b14 b24      a14 a24
//+0.038764238357544f, +0.0000000000f, -0.0387642383575439f,		+1.98188698291779f, -0.982018530368805f,    //b04 b14 b24      a14 a24
//+0.038739424198866f, +0.0000000000f, -0.0387394241988659f,		+1.97951781749725f, -0.979660451412201f,    //b04 b14 b24      a14 a24
//+0.037776891142130f, +0.0000000000f, -0.0377768911421299f,		+1.99564146995544f, -0.995735883712769f,    //b04 b14 b24      a14 a24
//+0.037042316049337f, +0.0000000000f, -0.0370423160493374f,		+1.99389243125916f, -0.993988990783691f,    //b04 b14 b24      a14 a24
//
//
//
//};
/* ----------------------------------------------------------------------
** IIR State Variables
**
** ------------------------------------------------------------------- */
float32_t aIIR_F32_States[2*NUM_STAGES] = {
+0.0000000000f, +0.0000000000f,		//d01 d11
+0.0000000000f, +0.0000000000f,		//d02 d12
+0.0000000000f, +0.0000000000f,	    //d03 d13
+0.0000000000f, +0.0000000000f,	    //d04 d14
};
//float32_t aIIR_F32_States[2*NUM_STAGES] = {
//+0.0000000000f, +0.0000000000f,		//d01 d11
//+0.0000000000f, +0.0000000000f,		//d02 d12
//+0.0000000000f, +0.0000000000f,	    //d03 d13
//+0.0000000000f, +0.0000000000f,	    //d04 d14
//+0.0000000000f, +0.0000000000f,		//d01 d11
//+0.0000000000f, +0.0000000000f,		//d02 d12
//+0.0000000000f, +0.0000000000f,	    //d03 d13
//+0.0000000000f, +0.0000000000f,	    //d04 d14
//+0.0000000000f, +0.0000000000f,		//d01 d11
//+0.0000000000f, +0.0000000000f,		//d02 d12
//+0.0000000000f, +0.0000000000f,	    //d03 d13
//+0.0000000000f, +0.0000000000f,	    //d04 d14
//+0.0000000000f, +0.0000000000f,		//d01 d11
//+0.0000000000f, +0.0000000000f,		//d02 d12
//+0.0000000000f, +0.0000000000f,	    //d03 d13
//+0.0000000000f, +0.0000000000f,	    //d04 d14
//+0.0000000000f, +0.0000000000f,		//d01 d11
//+0.0000000000f, +0.0000000000f,		//d02 d12
//+0.0000000000f, +0.0000000000f,	    //d03 d13
//+0.0000000000f, +0.0000000000f,	    //d04 d14
//+0.0000000000f, +0.0000000000f,		//d01 d11
//+0.0000000000f, +0.0000000000f,		//d02 d12
//+0.0000000000f, +0.0000000000f,	    //d03 d13
//+0.0000000000f, +0.0000000000f,	    //d04 d14
//+0.0000000000f, +0.0000000000f,		//d01 d11
//+0.0000000000f, +0.0000000000f,		//d02 d12
//+0.0000000000f, +0.0000000000f,	    //d03 d13
//+0.0000000000f, +0.0000000000f,	    //d04 d14
//};
/* ----------------------------------------------------------------------
/**
  * @brief  This function apply a Bandpass Butterworth IIR filter in to a F32 data signal.
  * @param  None
  * @retval None
  */
void IIR_PROCESSING_F32Process(uint32_t mode)
{

  arm_biquad_cascade_df2T_instance_f32 IIR_F32_Struct;
  float32_t aIIR_F32_BioZ_Data[TEST_LENGTH_SAMPLES] = { 0 };
  uint32_t counter_IIR_f32_p;
//  float32_t 	aIIR_F32_Output_Scaled[BLOCK_SIZE]={ 0 };
  float sum=0;
  float mean=0;

  if (mode == TEST_MODE)
  {
	  for (int i=0; i<BLOCK_SIZE; i++)
	  {
		  aIIR_F32_BioZ_Data[i] = aIIR_F32_BioZ_Test_Data[i];
	  }
  }
  else
  {
	  for (int i=0; i<BLOCK_SIZE; i++)
	  {
	  	  aIIR_F32_BioZ_Data[i] = bioz_data[i];
	  }
  }
  /* Call IIR init function to initialize the instance structure. */
  arm_biquad_cascade_df2T_init_f32(&IIR_F32_Struct, NUM_STAGES, (float32_t *)&aIIR_F32_Coeffs[0], &aIIR_F32_States[0]);

  if (mode == TEST_MODE)
  {
  printf("IIR init done - Buttherworth passband filter (0.1 - 0.8 Hz)\r\n");
  for (int i=0; i<5*NUM_STAGES; i++){
	  printf("IIR coeff %d = %f\r\n",i, IIR_F32_Struct.pCoeffs[i]);
    }
  }

  //remove DC component from the input signal
  for (int i=0; i<BLOCK_SIZE; i++){
	  sum = sum + aIIR_F32_BioZ_Data[i];
  }
  mean = sum/BLOCK_SIZE;

  if (mode == TEST_MODE)
  printf("BioZ_test_data\r\n");

  for (int i=0; i<BLOCK_SIZE; i++){
	  aIIR_F32_BioZ_Data[i] = aIIR_F32_BioZ_Data[i] - mean;
	  //printf("BioZ_test_data[%d] = %f \r\n", i, aIIR_F32_BioZ_Test_Data[i]);
	  if (mode == TEST_MODE)
	  printf("%f\r\n", aIIR_F32_BioZ_Data[i]);
    }

  /* Call the IIR process function for every blockSize samples */
//  TimerCount_Start();

  for (counter_IIR_f32_p = 0; counter_IIR_f32_p < numBlocks; counter_IIR_f32_p++)
  {
	  arm_biquad_cascade_df2T_f32(&IIR_F32_Struct, (float32_t *)&aIIR_F32_BioZ_Data[0], &aIIR_F32_Output[0], BLOCK_SIZE);
	  if (mode == TEST_MODE)
	  printf("Filtering done\r\n");
  }

 // TimerCount_Stop(nb_cycles);
  if (mode == TEST_MODE)
  printf("filter output data\r\n");
  for (int i=0; i<BLOCK_SIZE; i++){
  	  //printf("output data [%d] = %f\r\n",i,aIIR_F32_Output[i]);
	  //printf("%f\r\n",aIIR_F32_Output[i]);
	  aIIR_F32_Output_Scaled[i] = IIR_F32_Gain * aIIR_F32_Output[i];
	  if (mode == TEST_MODE)
	  printf("%f\r\n",aIIR_F32_Output_Scaled[i]);
  }
}
